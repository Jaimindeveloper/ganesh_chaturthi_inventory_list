<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Inventory List Report</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  </style>
</head>
<body class="bg-gray-100 p-6 text-center">
  <h2 class="text-3xl">|| શ્રીયોગેશ્વરોવિજયતેતરામ્ ||</h2>
  <br/>
  <h2 class="text-3xl">Inventory List Report</h2>
  <hr/>
  <br/>
  <h4 class="font-bold m-0" style="float:left; margin: 0px">District Wise Summary</h4>
  <button onclick="logout()" class="bg-red-600 text-white p-2 rounded" style="float:right">Logout</button>
  <br/>
  <table>
    <thead>
      <tr>
        <th>District</th>
        <th>Submitted Group Count</th>
        <th>Pending Group Count</th>
        <th>Submitted Groups</th>
        <th>Pending Groups</th>
      </tr>
    </thead>
    <tbody id="summaryTable"></tbody>
  </table>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script type="text/javascript">
    $(document).on("contextmenu", function(e) {
        e.preventDefault();
    });
    $(document).on("keydown", function(e) {
        if (e.keyCode == 123 || // F12
            (e.ctrlKey && e.shiftKey && (e.keyCode == 73 || e.keyCode == 74)) || // Ctrl+Shift+I/J
            (e.ctrlKey && e.keyCode == 85)) { // Ctrl+U
            e.preventDefault();
            return false;
        }
    });
    (function() {
        var threshold = 160; // Width difference to detect DevTools
        setInterval(function() {
            if (window.outerWidth - window.innerWidth > threshold || window.outerHeight - window.innerHeight > threshold) {
                document.body.innerHTML = "<h2>Developer Tools are not allowed!</h2>";
                window.location.href = "about:blank"; // or any warning page
            }
        }, 1000);
    })();
    Object.defineProperty(window, 'devtoolsOpen', {
        get: function() {
            return true;
        }
    });
  </script>
  <script>
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = '/inventory-report-admin';
    }

    function logout() {
      localStorage.removeItem('token');
      window.location.href = '/inventory-report-admin';
    }
  </script>
<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

  const URL = 'U2FsdGVkX19hyzc5WjKnwJeE9r+/IFyMdznhMX/0sW1Ht4ABbwzd0gK6exuEnd7N04eqeHdJqhMY3psodN82rw==';
  const KEY = 'U2FsdGVkX1+99BfCaCy7mhl0MiyZ4w3I40ZJ+neuSn2boVwGxa0RBvO1BwyhnJKb1jdwdcqRkGX57o/iaqIJ3aaI16Sx5aKeamlG0wuCxe4G1YFmLoWCtRFJwXId1gyA4P4C2o5ZxM/trE7iCB3xOsNlv90Hvgu0X5oH6uq9o2IesXwwKhgmvvm8xx/j9I0B1Ze5x3PGlwYvyoS9c3RK+7boDj2Z63TUV2nK7wVdjonLt6C3va767RZFb2WX7khrL5x2jnV6eD817HIUSzA+aC3PcvAGucq92bGuwrdVDVGmtll5ENfNxCxQhfuxPXgH';
  
  const keyBase64 = "bXlTdXBlclNlY3JldEtleTEyMw==";
  const secretKey = atob(keyBase64);
  let S_URL = null;
  let ANON_KEY = null;
  $.ajax({
      url: '/api/crypto',
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({ text: URL, action: 'decrypt' }),
      success: function(response) {
          S_URL = response.decrypted;
          $.ajax({
              url: '/api/crypto',
              method: 'POST',
              contentType: 'application/json',
              data: JSON.stringify({ text: KEY, action: 'decrypt' }),
              success: function(response) {
                  ANON_KEY = response.decrypted;

                  const supabase = createClient(S_URL, ANON_KEY);

                  async function fetchAllRows(tableName) {
                    let allData = [];
                    let from = 0;
                    let to = 999;
                    let hasMore = true;

                    while (hasMore) {
                      const { data, error } = await supabase
                        .from(tableName)
                        .select('*')
                        .range(from, to);

                      if (error) {
                        console.error(`Error fetching ${tableName}:`, error);
                        break;
                      }

                      if (data.length === 0) {
                        hasMore = false;
                      } else {
                        allData = allData.concat(data);
                        from += 1000;
                        to += 1000;
                      }
                    }

                    return allData;
                  }

                  async function loadSummary() {
                    const locations = await fetchAllRows('location_master');
                    const records = await fetchAllRows('inventory_records');

                    if (!locations.length && !records.length) {
                      $('#summaryTable').html('<tr><td colspan="5">No data found</td></tr>');
                      return;
                    }

                    // Convert submitted groups into a Set
                    const submittedGroups = new Set(records.map(r => r.group_name));

                    // Group location data by district
                    const districtMap = {};
                    locations.forEach(loc => {
                      const district = loc.District ? loc.District.trim() : '';
                      const group = loc.Group ? loc.Group.trim() : '';

                      if (district && group) {
                        if (!districtMap[district]) {
                          districtMap[district] = new Set();
                        }
                        districtMap[district].add(group);
                      }
                    });

                    // Build HTML rows
                    let html = '';
                    for (const district in districtMap) {
                      const allGroups = Array.from(districtMap[district]);
                      const submitted = allGroups.filter(g => submittedGroups.has(g));
                      const notSubmitted = allGroups.filter(g => !submittedGroups.has(g));

                      html += `
                        <tr>
                          <td>${district}</td>
                          <td>${submitted.length}</td>
                          <td>${notSubmitted.length}</td>
                          <td>${submitted.length ? submitted.join(', ') : '-'}</td>
                          <td>${notSubmitted.length ? notSubmitted.join(', ') : '-'}</td>
                        </tr>`;
                    }

                    $('#summaryTable').html(html);
                  }


                  $(document).ready(loadSummary);

                },
              error: function() {
                  $('#result').text('Decryption failed');
              }
          });

      },
      error: function() {
          $('#result').text('Decryption failed');
      }
  });
</script>
</body>
</html>