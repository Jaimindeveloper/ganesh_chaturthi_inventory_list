<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>District Summary</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  </style>
</head>
<body class="bg-gray-100 p-6 text-center">
  <h2 class="text-3xl">|| શ્રીયોગેશ્વરોવિજયતેતરામ્ ||</h2>
  <br/>
  <h2 class="text-3xl">Inventory List Report</h2>
  <hr/>
  <br/>
  <h4 class="font-bold m-0" style="float:left; margin: 0px">District Wise Summary</h4>
  <button onclick="logout()" class="bg-red-600 text-white p-2 rounded" style="float:right">Logout</button>
  <br/>
  <table>
    <thead>
      <tr>
        <th>District</th>
        <th>Submitted Group Count</th>
        <th>Pending Group Count</th>
        <th>Submitted Groups</th>
        <th>Pending Groups</th>
      </tr>
    </thead>
    <tbody id="summaryTable"></tbody>
  </table>
  <script type="text/javascript">
    $(document).on("contextmenu", function(e) {
        e.preventDefault();
    });
    $(document).on("keydown", function(e) {
        if (e.keyCode == 123 || // F12
            (e.ctrlKey && e.shiftKey && (e.keyCode == 73 || e.keyCode == 74)) || // Ctrl+Shift+I/J
            (e.ctrlKey && e.keyCode == 85)) { // Ctrl+U
            e.preventDefault();
            return false;
        }
    });
    (function() {
        var threshold = 160; // Width difference to detect DevTools
        setInterval(function() {
            if (window.outerWidth - window.innerWidth > threshold || window.outerHeight - window.innerHeight > threshold) {
                document.body.innerHTML = "<h2>Developer Tools are not allowed!</h2>";
                window.location.href = "about:blank"; // or any warning page
            }
        }, 1000);
    })();
    Object.defineProperty(window, 'devtoolsOpen', {
        get: function() {
            return true;
        }
    });
  </script>
  <script>
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = '/inventory-report-admin';
    }

    function logout() {
      localStorage.removeItem('token');
      window.location.href = '/inventory-report-admin';
    }
  </script>
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    // Replace with your Supabase credentials
    const SUPABASE_URL = 'https://qbwcbmfxiljzoinxueup.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFid2NibWZ4aWxqem9pbnh1ZXVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMTE5MDQsImV4cCI6MjA3MTY4NzkwNH0.2hT05Ec00_QUbmn5c3Dt4RwA4lYMi4bUO2mpnyewn-c';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function fetchAllRows(tableName) {
      let allData = [];
      let from = 0;
      let to = 999;
      let hasMore = true;

      while (hasMore) {
        const { data, error } = await supabase
          .from(tableName)
          .select('*')
          .range(from, to);

        if (error) {
          console.error(`Error fetching ${tableName}:`, error);
          break;
        }

        if (data.length === 0) {
          hasMore = false;
        } else {
          allData = allData.concat(data);
          from += 1000;
          to += 1000;
        }
      }

      return allData;
    }

    async function loadSummary() {
      const locations = await fetchAllRows('location_master');
      const records = await fetchAllRows('inventory_records');

      if (!locations.length && !records.length) {
        $('#summaryTable').html('<tr><td colspan="5">No data found</td></tr>');
        return;
      }

      // Convert submitted groups into a Set
      const submittedGroups = new Set(records.map(r => r.group_name));

      // Group location data by district
      const districtMap = {};
      locations.forEach(loc => {
        const district = loc.District ? loc.District.trim() : '';
        const group = loc.Group ? loc.Group.trim() : '';

        if (district && group) {
          if (!districtMap[district]) {
            districtMap[district] = new Set();
          }
          districtMap[district].add(group);
        }
      });

      // Build HTML rows
      let html = '';
      for (const district in districtMap) {
        const allGroups = Array.from(districtMap[district]);
        const submitted = allGroups.filter(g => submittedGroups.has(g));
        const notSubmitted = allGroups.filter(g => !submittedGroups.has(g));

        html += `
          <tr>
            <td>${district}</td>
            <td>${submitted.length}</td>
            <td>${notSubmitted.length}</td>
            <td>${submitted.length ? submitted.join(', ') : '-'}</td>
            <td>${notSubmitted.length ? notSubmitted.join(', ') : '-'}</td>
          </tr>`;
      }

      $('#summaryTable').html(html);
    }


    $(document).ready(loadSummary);
  </script>
</body>
</html>