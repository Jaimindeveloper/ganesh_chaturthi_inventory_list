<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Manrope', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #f4f6f9;
    }
    .form-container {
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0px 4px 12px rgba(0,0,0,0.1);
      width: 100%;
    }
    h2,h3,h4,h5 { text-align: center; }
    label {     
      font-weight: 500;
      margin-top: 10px;
      display: block;
      font-size: 15px;
    }
    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button {
      background: #4CAF50; color: white; border: none; padding: 10px 20px;
      border-radius: 8px; cursor: pointer; width: 100%; font-size: 16px;
    }
    table {
        width: 80%;
        margin: 20px auto;
        border-collapse: collapse;
        font-size: 15px;
        font-family: 'Manrope', sans-serif;
    }
    th, td {
        border: 1px solid #333;
        padding: 8px;
        text-align: center;
    }
    th {
        background-color: #f1f1f1;
    }
    td input {
      width: auto;
      text-align: center;
      min-width: 90%;
      margin: 0px;
    }
    table input[type="number"] {
      width: auto;
      text-align: center;
      min-width: 90%;
      margin: 0px;
    }
    table input[type="text"] {
      width: auto;
      text-align: center;
      min-width: 90%;
      margin: 0px;
    }
    .title {
        font-size: 20px;
        margin-bottom: 15px;
        font-weight: bold;
    }
    .button:hover {
        background: #218838;
    }
    #loaderOverlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      backdrop-filter: blur(4px);
      background-color: rgba(255, 255, 255, 0.2);
      z-index: 1999;
    }

    #loader {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 18px;
      color: #333;
      background: white;
      padding: 20px 30px;
      border: 1px solid #aaa;
      border-radius: 10px;
      z-index: 2000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    .error {
      border: 2px solid red !important;
    }
    .req {
      color:red;
    }
    /* Disabled select style */
    select:disabled {
      background-color: #f0f0f0; /* gray background */
      color: #888;                /* lighter text */
      border: 1px solid #aaa;     /* darker border */
      cursor: not-allowed;        /* show disabled cursor */
    }
    /* For Chrome, Safari, Edge, Opera */
    .qty::-webkit-outer-spin-button,
    .qty::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    /* For Firefox */
    .qty[type=number] {
        -moz-appearance: textfield;
    }
</style>
</head>
<body>
  <!-- Blurred overlay -->
  <div id="loaderOverlay"></div>

  <!-- Loader box -->
  <div id="loader">
    ⏳ Loading, please wait...
  </div>
  <div class="form-container">
    <h2>|| શ્રીયોગેશ્વરોવિજયતેતરામ્ ||</h2>
    <h2>ગામમાં સ્વાધ્યાય કાર્યમાં વપરાતી વસ્તુઓની યાદી</h2>
    <hr/>
    <br/>
    <label>વિગત આપનાર ભાઈ નું નામ<span class="req">*</span></label>
    <input type="text" id="fullName" required placeholder="Lastname Firstname Middlename">

    <label>સંપર્ક નંબર<span class="req">*</span></label>
    <input type="text" id="mobile" required>

    <label>જીલ્લો<span class="req">*</span></label>
    <select id="district" required>
      <option value="">Select District</option>
    </select>

    <label>તાલુકો<span class="req">*</span></label>
    <select id="taluka" required></select>
    <input type="checkbox" id="otherTalukaCheckbox"> અન્ય તાલુકા
    <input type="text" id="otherTalukaInput" placeholder="Enter Other Taluka" style="display:none;">
    <br/>
    <label>ગ્રુપ<span class="req">*</span></label>
    <select id="group" required></select>
    <input type="checkbox" id="otherGroupCheckbox"> અન્ય ગ્રુપ
    <input type="text" id="otherGroupInput" placeholder="Enter Other Group" style="display:none;">
    <br/>
    <label>ગામનું નામ<span class="req">*</span></label>
    <input type="text" id="gam" required placeholder="">
    <br/>
    <label for="noInventory"><input type="checkbox" id="noInventory" value="true"> ગામ પાસે કોઈ વસ્તુ/ઈન્વેન્ટરી નથી</label>
    <br/>
    <div id="itemList">
      <h3 style="text-align:center">વસ્તુની વિગત અને સંખ્યા</h3>
      <h4>( આપણા ગામમાં / કેન્દ્રમાં  જે વસ્તુ હશે તેની વિગતો લખીશું, બીજા ખાના ખાલી રાખીશું. )</h4>
      <table id="itemsTable">
        <thead>
            <tr>
                <th>ક્રમ</th>
                <th style="width: 200px;">વસ્તુની વિગત</th>
                <th>સંખ્યા</th>
                <th>ટિપ્પણી</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>
    <br/>
    
    <button onclick="submitForm()">Submit</button>
    <p id="msg" style="color:green; text-align:center; margin-top:10px;"></p>
  </div>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script type="text/javascript">
    $(document).on("contextmenu", function(e) {
        e.preventDefault();
    });
    $(document).on("keydown", function(e) {
        if (e.keyCode == 123 || // F12
            (e.ctrlKey && e.shiftKey && (e.keyCode == 73 || e.keyCode == 74)) || // Ctrl+Shift+I/J
            (e.ctrlKey && e.keyCode == 85)) { // Ctrl+U
            e.preventDefault();
            return false;
        }
    });
    (function() {
        var threshold = 160; // Width difference to detect DevTools
        setInterval(function() {
            if (window.outerWidth - window.innerWidth > threshold || window.outerHeight - window.innerHeight > threshold) {
                document.body.innerHTML = "<h2>Developer Tools are not allowed!</h2>";
                window.location.href = "about:blank"; // or any warning page
            }
        }, 1000);
    })();
    Object.defineProperty(window, 'devtoolsOpen', {
        get: function() {
            return true;
        }
    });
  </script>
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const URL = 'U2FsdGVkX19hyzc5WjKnwJeE9r+/IFyMdznhMX/0sW1Ht4ABbwzd0gK6exuEnd7N04eqeHdJqhMY3psodN82rw==';
    const KEY = 'U2FsdGVkX1+99BfCaCy7mhl0MiyZ4w3I40ZJ+neuSn2boVwGxa0RBvO1BwyhnJKb1jdwdcqRkGX57o/iaqIJ3aaI16Sx5aKeamlG0wuCxe4G1YFmLoWCtRFJwXId1gyA4P4C2o5ZxM/trE7iCB3xOsNlv90Hvgu0X5oH6uq9o2IesXwwKhgmvvm8xx/j9I0B1Ze5x3PGlwYvyoS9c3RK+7boDj2Z63TUV2nK7wVdjonLt6C3va767RZFb2WX7khrL5x2jnV6eD817HIUSzA+aC3PcvAGucq92bGuwrdVDVGmtll5ENfNxCxQhfuxPXgH';
    
    const keyBase64 = "bXlTdXBlclNlY3JldEtleTEyMw==";
    const secretKey = atob(keyBase64);
    let S_URL = null;
    let ANON_KEY = null;
    $.ajax({
        url: '/api/crypto',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ text: URL, action: 'decrypt' }),
        success: function(response) {
            S_URL = response.decrypted;
            $.ajax({
                url: '/api/crypto',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ text: KEY, action: 'decrypt' }),
                success: function(response) {
                    ANON_KEY = response.decrypted;

                    const supabase = createClient(S_URL, ANON_KEY);
                    const items = [
                      { gu: "પાથરણા", en: "patharana" },
                      { gu: "સ્ટેન્ડ (પ્રતિકૃતિ માટે)", en: "stand" },
                      { gu: "ટીવી", en: "tv" },
                      { gu: "વીસીઆર/વિસીપી", en: "vcr" },
                      { gu: "એમ્પ્લીફાયર", en: "amplifier" },
                      { gu: "સ્પીકર્સ", en: "speakers" },
                      { gu: "માઈક્રોફોન", en: "microphone" },
                      { gu: "જનરેટર સેટ", en: "generator_set" },
                      { gu: "ઈલેક્ટ્રીકલ કીટ", en: "electrical_kit" },
                      { gu: "પુસ્તકો", en: "books" },
                      { gu: "પુસ્તકો માટે કબાટ", en: "book_cupboard" },
                      { gu: "પુજારી ની કીટ", en: "pujari_kit" },
                      { gu: "પાલખી જૂની", en: "palakhi_old" },
                      { gu: "પાલખી નવી", en: "palakhi_new" },
                      { gu: "સોલાર લેમ્પ જુના", en: "solar_lamp_old" },
                      { gu: "સોલાર લેમ્પ નવા", en: "solar_lamp_new" },
                      { gu: "ખેતી ના સાધનો", en: "farming_tools" },
                      { gu: "ફર્સ્ટ એઇડ બોક્સ", en: "first_aid_box" }
                    ];
                    const tbody = document.querySelector("#itemsTable tbody");

                    // Dynamically create rows
                    items.forEach((item, index) => {
                        const tr = document.createElement("tr");
                        // Serial No
                        const tdIndex = document.createElement("td");
                        tdIndex.textContent = index + 1;
                        tr.appendChild(tdIndex);

                        // Item Name
                        const tdItem = document.createElement("td");
                        tdItem.textContent = item.gu;
                        
                        tr.appendChild(tdItem);

                        // Six Gam qty inputs
                        for (let i = 1; i <= 2; i++) {
                            const tdInput = document.createElement("td");
                            const input = document.createElement("input");
                            if (i == 2) {
                              input.type = "text";
                              input.id = `item${index + 1}_gam${i}`;
                            } else {
                              input.type = "number";
                              input.min = "0";
                              input.className = "qty";
                              input.id = item.en;
                            }
                            tdInput.appendChild(input);
                            tr.appendChild(tdInput);
                        }
                        
                        tbody.appendChild(tr);
                    });

                    const districtSelect = document.getElementById('district');
                    const talukaSelect = document.getElementById('taluka');
                    const groupSelect = document.getElementById('group');

                    // ✅ Load all data once (or you can fetch on each change)
                    let viewData = [];

                    // Fetch view data on load
                    async function loadData() {
                      let from = 0;
                      let to = 999;
                      let hasMore = true;

                      while (hasMore) {
                        const { data, error } = await supabase
                          .from('location_master')
                          .select('*')
                          .range(from, to);

                        if (error) {
                          console.error('Error fetching data:', error);
                          break;
                        }

                        if (data.length === 0) {
                          hasMore = false;
                        } else {
                          viewData = viewData.concat(data);
                          from += 1000;
                          to += 1000;
                        }
                      }
                      
                      // Extract unique districts
                      const districts = [...new Set(viewData.map(item => item.District))];

                      districts.forEach(d => {
                        const option = document.createElement('option');
                        option.value = d;
                        option.textContent = d;
                        districtSelect.appendChild(option);
                      });
                    }

                    async function capitalizeEachWordAsync(str = '') {
                      if (typeof str !== 'string') return '';
                      return str
                        .toLowerCase()
                        .trim()
                        .split(/\s+/)
                        .map(w => w.charAt(0).toUpperCase() + w.slice(1))
                        .join(' ');
                    }
                    // When district changes → load talukas
                    districtSelect.addEventListener('change', () => {
                      talukaSelect.innerHTML = '<option value="">Select Taluka</option>';
                      groupSelect.innerHTML = '<option value="">Select Group</option>';
                      groupSelect.disabled = true;

                      const district = districtSelect.value;
                      if (!district) {
                        talukaSelect.disabled = true;
                        return;
                      }

                      const talukas = [
                        ...new Set(viewData
                          .filter(item => item.District === district)
                          .map(item => item.Taluka))
                      ];

                      talukas.forEach(t => {
                        const option = document.createElement('option');
                        option.value = t;
                        option.textContent = t;
                        talukaSelect.appendChild(option);
                      });

                      talukaSelect.disabled = false;
                    });

                    // When taluka changes → load groups
                    talukaSelect.addEventListener('change', () => {
                      groupSelect.innerHTML = '<option value="">Select Group</option>';

                      const district = districtSelect.value;
                      const taluka = talukaSelect.value;

                      if (!taluka) {
                        groupSelect.disabled = true;
                        return;
                      }

                      const groups = [
                        ...new Set(viewData
                          .filter(item => item.District === district && item.Taluka === taluka)
                          .map(item => item.Group))
                      ];

                      groups.forEach(g => {
                        const option = document.createElement('option');
                        option.value = g;
                        option.textContent = g;
                        groupSelect.appendChild(option);
                      });

                      groupSelect.disabled = false;
                    });

                    loadData();

                    window.submitForm = async function() {
                      let validQty = true;
                      // Validate Full Name
                      const fullNameInput = document.getElementById("fullName");
                      const fullnameValue = fullNameInput.value.trim();

                      if (!validateFullName(fullnameValue)) {
                          alert("Please enter valid full name (e.g., Lastname Firstname Middlename)");
                          fullNameInput.classList.add("error"); // ✅ Correct method
                          return;
                      } else {
                          fullNameInput.classList.remove("error");
                      }

                      const mobileInput = document.getElementById("mobile");
                      const mobileValue = mobileInput.value.trim();

                      if (!validateMobile(mobileValue)) {
                          alert("Please enter a valid 10-digit mobile number.");
                          mobileInput.classList.add("error"); // ✅ Correct method
                          return; // Stop form submission
                      } else {
                          mobileInput.classList.remove("error");
                      }

                      const taluka = document.getElementById("taluka");
                      const group = document.getElementById("group");

                      const otherTalukaCheckbox = document.getElementById("otherTalukaCheckbox");
                      const otherTalukaInput = document.getElementById("otherTalukaInput");

                      // Validate Taluka
                      if (otherTalukaCheckbox.checked) {
                          // Validate the manual input
                          const value = otherTalukaInput.value.trim();
                          const regex = /^[A-Za-z0-9\s]+$/; // First letter capital, letters only

                          if (value === "") {
                              alert("Please enter Taluka.");
                              otherTalukaInput.classList.add("error");
                              return false;
                          } else if (!regex.test(value)) {
                              alert("Please enter valid taluka name.");
                              otherTalukaInput.classList.add("error");
                              return false;
                          } else {
                              otherTalukaInput.classList.remove("error");
                          }

                      } else {
                          // Validate Taluka
                          if (!taluka.value) {
                              alert("Please select a Taluka.");
                              taluka.classList.add("error");
                              return;
                          } else {
                              taluka.classList.remove("error");
                          }
                      }

                      const otherGroupCheckbox = document.getElementById("otherGroupCheckbox");
                      const otherGroupInput = document.getElementById("otherGroupInput");

                      // Validate Group
                      if (otherGroupCheckbox.checked) {
                          // Validate the manual input
                          const value = otherGroupInput.value.trim();
                          const regex = /^[A-Za-z0-9\s]+$/; // First letter capital, letters only

                          if (value === "") {
                              alert("Please enter Group.");
                              otherGroupInput.classList.add("error");
                              return false;
                          } else if (!regex.test(value)) {
                              alert("Please enter valid group name.");
                              otherGroupInput.classList.add("error");
                              return false;
                          } else {
                              otherGroupInput.classList.remove("error");
                          }

                      } else {
                          // Validate Group
                          if (!group.value) {
                              alert("Please select a Group.");
                              group.classList.add("error");
                              return;
                          } else {
                              group.classList.remove("error");
                          }
                      }
                      
                      const gamInput = document.getElementById("gam");
                      const gamValue = gamInput.value.trim();

                      if (!isValidFirstLetterCapital(gamValue)) {
                          alert("Please enter valid gam name.");
                          gamInput.classList.add("error"); // ✅ Correct method
                          return;
                      } else {
                          gamInput.classList.remove("error");
                      }

                      // Validate Quantity Inputs input.value == "" || 
                      document.querySelectorAll(".qty").forEach(input => {
                        if (isNaN(input.value) || input.value < 0) {
                            input.classList.add("error");  // Add error class if invalid
                            validQty = false;
                        } else {
                            input.classList.remove("error"); // Remove error if valid
                        }
                      });

                      if (!validQty) {
                        alert("Please enter valid quantity values (non-negative numbers only).");
                        return; // Stop further execution
                      }

                      // Show loader
                      document.getElementById('loader').style.display = 'block';
                      document.getElementById('loaderOverlay').style.display = 'block';

                      const talukaFormData = (otherTalukaCheckbox.checked) ? document.getElementById("otherTalukaInput").value : document.getElementById("taluka").value;
                      const groupFormData = (otherGroupCheckbox.checked) ? document.getElementById("otherGroupInput").value : document.getElementById("group").value;
                      const checkbox = document.getElementById("noInventory");
                      let formData = {
                        full_name: await capitalizeEachWordAsync(document.getElementById("fullName").value),
                        mobile: document.getElementById("mobile").value,
                        district: document.getElementById("district").value,
                        taluka: talukaFormData,
                        group_name: groupFormData,
                        gam: await capitalizeEachWordAsync(document.getElementById("gam").value),
                        no_inventory: checkbox.checked ? "true" : "false"
                      };

                      let index = 1;

                      document.querySelectorAll("#itemsTable tr").forEach(row => {
                        const cols = row.querySelectorAll("td");
                        if (cols.length >= 4) {  // Ensure enough columns
                          let item = cols[2].querySelector("input").id;
                          const qtyValues = cols[2].querySelector("input").value.trim();
                          const remarks = cols[3].querySelector("input").value.trim();

                          let qtyVal = remarks !== '' ? `${qtyValues} (${remarks})` : qtyValues;

                          // Add dynamic key like item1, item2, item3...
                          formData[item] = `${qtyVal}`;
                          index++;
                        }
                      });

                      const { data, error } = await supabase
                        .from('inventory_records')
                        .insert([formData]); // Pass your object inside an array

                      if (error) {
                        console.error(error);
                        alert('Error: ' + error.message);
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                      } else {
                        alert("✅ ગામનો ડેટા સફળતાપૂર્વક Submit થઈ ગયો છે");
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                      }
                    };

                    function validateFullName(nameField) {
                      // Regex: Each word starts with uppercase letter followed by lowercase letters
                      const namePattern = /^[A-Za-z\s]+$/;
                      return namePattern.test(nameField);
                    }
                    function validateMobile(mobile) {
                        const mobilePattern = /^[0-9]{10}$/;
                        return mobilePattern.test(mobile);
                    }
                    function isValidFirstLetterCapital(value) {
                        return /^[A-Za-z0-9\s]+$/.test(value);
                    }
                    // Select all inputs
                    document.querySelectorAll('input, select').forEach(input => {
                      input.addEventListener('focus', function () {
                        this.classList.remove('error');
                      });
                    });

                    document.getElementById("noInventory").addEventListener("change", function() {
                      const itemListDiv = document.getElementById("itemList");
                      if (this.checked) {
                        itemListDiv.style.display = "none";
                      } else {
                        itemListDiv.style.display = "block";
                      }
                    });

                    document.getElementById("otherTalukaCheckbox").addEventListener("change", function() {
                      const otherInput = document.getElementById("otherTalukaInput");
                      const talukaSelect = document.getElementById("taluka");
                      talukaSelect.classList.remove("error");
                      otherInput.classList.remove("error");
                      if (this.checked) {
                          otherInput.style.display = "inline-block"; // Show text input
                          otherInput.required = true;
                          talukaSelect.disabled = true; // Disable dropdown
                      } else {
                          otherInput.style.display = "none"; // Hide text input
                          otherInput.required = false;
                          talukaSelect.disabled = false; // Enable dropdown
                          otherInput.value = ""; // Clear text input
                      }
                    });
                    document.getElementById("otherGroupCheckbox").addEventListener("change", function() {
                      const otherInput = document.getElementById("otherGroupInput");
                      const groupSelect = document.getElementById("group");
                      groupSelect.classList.remove("error");
                      otherInput.classList.remove("error");
                      if (this.checked) {
                          otherInput.style.display = "inline-block"; // Show text input
                          otherInput.required = true;
                          groupSelect.disabled = true; // Disable dropdown
                          groupSelect.classList.remove("error");
                      } else {
                          otherInput.style.display = "none"; // Hide text input
                          otherInput.required = false;
                          groupSelect.disabled = false; // Enable dropdown
                          otherInput.value = ""; // Clear text input
                      }
                    });
                    
                },
                error: function() {
                    $('#result').text('Decryption failed');
                }
            });

        },
        error: function() {
            $('#result').text('Decryption failed');
        }
    });
    
  </script>
</body>
</html>